(window.webpackJsonp=window.webpackJsonp||[]).push([["PushNotifications"],{"./src/lib/timezone/index.ts":function(t,e,n){"use strict";n.d(e,"a",function(){return o}),n.d(e,"b",function(){return a}),n.d(e,"e",function(){return c}),n.d(e,"d",function(){return u}),n.d(e,"f",function(){return d}),n.d(e,"g",function(){return l}),n.d(e,"c",function(){return f});var i=n("./src/lib/constants/index.ts"),r=n("./src/reddit/models/PostCreationForm/index.ts"),s=function(){return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,r=!1,s=void 0;try{for(var o,a=t[Symbol.iterator]();!(i=(o=a.next()).done)&&(n.push(o.value),!e||n.length!==e);i=!0);}catch(c){r=!0,s=c}finally{try{!i&&a.return&&a.return()}finally{if(r)throw s}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();const o="America/Los_Angeles",a=()=>{let t;try{t=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(e){}return"Asia/Calcutta"===t&&(t="Asia/Kolkata"),t||void 0},c=t=>{const e=Math.abs(t),n=e%60;return`${t>0?"-":"+"}${("0"+Math.floor(e/60)).slice(-2)}:${("0"+n).slice(-2)}`},u=(t,e)=>{const n=e||Date.now(),r={year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",timeZoneName:"short",hour12:!1,timeZone:t};let o="";try{o=new Intl.DateTimeFormat("en-US",r).format(new Date(n))}catch(S){return}var a=o.replace(", "," ").split(" "),c=s(a,3);const u=c[0],d=c[1],l=c[2];var f=u.trim().split("/").map(Number),p=s(f,3);const b=p[0],m=p[1],g=p[2];var v=d.trim().split(":").map(Number),h=s(v,3);const j=h[0],O=h[1],w=h[2],_=Date.UTC(g,b-1,m,j,O,w),k=new Date(n).setMilliseconds(0)-_;return{abbreviation:l,offset:Math.round(k/i.Ja)}},d=t=>{var e=t.slice(0,19).split("T"),n=s(e,2);const i=n[0],r=n[1];var o=i.split("-").map(Number),a=s(o,3);const c=a[0],u=a[1],d=a[2];var l=r.split(":").map(Number),f=s(l,3);const p=f[0],b=f[1];var m=f[2];return new Date(c,u-1,d,p,b,void 0===m?0:m)},l=t=>{const e=new Date(t);return e.setMinutes(e.getMinutes()-e.getTimezoneOffset()),e.toISOString().slice(0,16)},f=t=>{if(t&&t.eventInfo){var e=t.eventInfo;const n=e.eventStart,s=e.eventEnd;return{startDate:l(new Date(n*i.vb)),endDate:l(new Date(s*i.vb)),submitTime:r.i.Now,timezoneName:a()||o}}}},"./src/reddit/actions/notifications/index.ts":function(t,e,n){"use strict";n.r(e);var i=n("./src/config.ts"),r=n("./src/lib/browser/isIncognito.ts"),s=n("./src/lib/constants/index.ts"),o=n("./src/lib/localStorageAvailable/index.ts"),a=n("./src/reddit/actions/notifications/constants.ts"),c=n("./src/reddit/actions/notifications/utils.ts"),u=n("./src/lib/makeGqlRequest/index.ts"),d=n("./src/lib/timezone/index.ts");var l=n("./src/reddit/helpers/trackers/notifications.ts"),f=n("./src/reddit/selectors/experiments/dnPrePrompt.ts"),p=n("./src/reddit/selectors/notificationPrefs.ts"),b=n("./src/reddit/selectors/user.ts");n.d(e,"getBrowserNotificationPermission",function(){return g}),n.d(e,"resetPermissionRequestClosed",function(){return v}),n.d(e,"isBrowserSubscribedForPushNotifications",function(){return h}),n.d(e,"initializeServiceWorkerChannel",function(){return w}),n.d(e,"requestNotificationsPermissions",function(){return _}),n.d(e,"subscribeForPNs",function(){return k}),n.d(e,"unsubscribeFromPNs",function(){return S});const m=4*s.N,g=()=>{const t=Object(o.a)()&&"1"===localStorage.getItem("notification-permission-request-closed");return"granted"===Notification.permission?a.a.Granted:"denied"===Notification.permission?a.a.Denied:t?a.a.Closed:a.a.Default},v=()=>!!Object(o.a)()&&(localStorage.removeItem("notification-permission-request-closed"),!0),h=async()=>{let t;try{t=await navigator.serviceWorker.register("/sw.js")}catch(e){return!1}return null!==await t.pushManager.getSubscription()},j=()=>{navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({command:"registerClient"})};let O=!1;const w=async t=>{if(O)return;if(O=!0,Object(c.a)(t)!==a.f.NotificationsSupported)return;try{await navigator.serviceWorker.register("/sw.js")}catch(e){return}navigator.serviceWorker.addEventListener("message",e=>{const n=e.data,i=n.command;if("logInteraction"===i){const e=n.interactionType,i=n.payload.correlation_id;"push"===e?l.l(t,i):"notificationclick"===e?l.j(t,i):"notificationclose"===e&&l.k(t,i)}else"registerWithServiceWorker"===i&&j()}),j()},_=(t,e)=>async(n,i,s)=>{const u=i();if(await Object(r.a)())return;const d=Object(f.a)(u);if(!Object(b.B)(u)&&!d)return;if(await w(u),Object(o.a)()){const e=localStorage.getItem("push-token-last-refresh-ms"),n=(new Date).getTime();if(!t&&e&&parseInt(e)+m>n)return;localStorage.setItem("push-token-last-refresh-ms",n.toString())}l.n(u);const g=Object(c.a)(u);if(g===a.f.BrowserUnsupported)return void l.m(u,"unsupported_browser");if(g===a.f.LocalStorageUnavailable)return void l.m(u,"local_storage_unavailable");if(g===a.f.NotAllRequiredAPIsSupported)return void l.m(u,"not_all_push_apis_supported");if("denied"===Notification.permission)return n(Object(a.p)()),void l.m(u,"already_denied");if("granted"===Notification.permission)return n(Object(a.q)()),void n(k());const v=localStorage.getItem("notification-permission-request-closed");if(!e&&v&&"1"===v)return void l.m(u,"notification_permission_request_closed");const h=localStorage.getItem(a.i);if(e||!h||h!==a.j)if(e||!d||Object(p.c)(u)||(n(Object(a.s)()),!Object(f.c)(d)))switch(n(Object(a.r)()),l.i(u),await Notification.requestPermission()){case"granted":n(Object(a.q)()),n(k()),l.b(u);break;case"denied":n(Object(a.p)()),l.c(u);break;default:n(Object(a.p)()),l.d(u),localStorage.setItem("notification-permission-request-closed","1")}else l.h(i());else l.m(u,"preprompt_closed")},k=()=>async(t,e,n)=>{const r=e();try{const t=await navigator.serviceWorker.register("/sw.js");let o=await t.pushManager.getSubscription();if(!o){const e={userVisibleOnly:!0,applicationServerKey:(t=>{const e=(t+"=".repeat((4-t.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),n=window.atob(e),i=new Uint8Array(n.length);for(let r=0;r<n.length;++r)i[r]=n.charCodeAt(r);return i})(i.a.pushNotificationApplicationServerKey)};o=await t.pushManager.subscribe(e)}const a=await((t,e,n)=>{const i={pushToken:JSON.stringify(n),timezoneName:Object(d.b)()||d.a,timestamp:(new Date).toISOString(),language:"en_us"};return Object(u.a)(t,{id:"033b409ffde6",variables:i})})(n.gqlContext(),e(),o),c=a.body.data.registerWebPushToken;a.ok?c&&!c.ok?l.m(r,"registration_failed_in_gql"):l.o(r):l.m(r,"registration_failed_generally")}catch(s){l.m(r,"registration_failed_uncaught_exception")}},S=()=>async(t,e,n)=>{try{const t=await navigator.serviceWorker.register("/sw.js"),e=await t.pushManager.getSubscription();e&&e.unsubscribe()}catch(i){}}},"./src/reddit/actions/notifications/utils.ts":function(t,e,n){"use strict";n.d(e,"a",function(){return o});var i=n("./src/lib/localStorageAvailable/index.ts"),r=n("./src/reddit/actions/notifications/constants.ts"),s=n("./src/reddit/featureFlags/index.ts");const o=t=>s.d.pushNotificationsBrowserSupported(t)?Object(i.a)()?window.Notification&&window.ServiceWorker&&window.PushManager?r.f.NotificationsSupported:r.f.NotAllRequiredAPIsSupported:r.f.LocalStorageUnavailable:r.f.BrowserUnsupported},"./src/reddit/helpers/trackers/notifications.ts":function(t,e,n){"use strict";n.d(e,"i",function(){return c}),n.d(e,"b",function(){return u}),n.d(e,"c",function(){return d}),n.d(e,"d",function(){return l}),n.d(e,"h",function(){return f}),n.d(e,"f",function(){return p}),n.d(e,"g",function(){return b}),n.d(e,"n",function(){return g}),n.d(e,"o",function(){return v}),n.d(e,"m",function(){return h}),n.d(e,"j",function(){return O}),n.d(e,"k",function(){return w}),n.d(e,"l",function(){return _}),n.d(e,"a",function(){return P}),n.d(e,"e",function(){return M});var i=n("./src/reddit/models/PushNotification/index.ts"),r=n("./src/reddit/selectors/telemetry.ts"),s=n("./src/telemetry/index.ts");const o=t=>Object.assign({},r.defaults(t),{noun:"desktop_notification_permissions"}),a=t=>Object.assign({},r.defaults(t),{noun:"desktop_notif_preprompt_permissions"}),c=t=>{Object(s.a)(Object.assign({},o(t),{action:"view",source:"popup"}))},u=t=>{Object(s.a)(Object.assign({},o(t),{action:"allow",source:"popup"}))},d=t=>{Object(s.a)(Object.assign({},o(t),{action:"block",source:"popup"}))},l=t=>{Object(s.a)(Object.assign({},o(t),{action:"close",source:"popup"}))},f=t=>{Object(s.a)(Object.assign({},a(t),{action:"view",source:"popup"}))},p=t=>{Object(s.a)(Object.assign({},a(t),{action:"allow",source:"popup"}))},b=t=>{Object(s.a)(Object.assign({},a(t),{action:"close",source:"popup"}))},m=(t,e,n)=>Object.assign({},r.defaults(t),{actionInfo:r.actionInfo(t,{success:e,reason:n}),noun:"desktop_push_token"}),g=t=>{Object(s.a)(Object.assign({},m(t,!0),{action:"request",source:"notifications"}))},v=t=>{Object(s.a)(Object.assign({},m(t,!0),{action:"register",source:"notifications"}))},h=(t,e)=>{Object(s.a)(Object.assign({},m(t,!1,e),{action:"bail",source:"notifications"}))},j=t=>Object.assign({},r.defaults(t),{noun:"desktop_push_notification"}),O=(t,e)=>{Object(s.a)(Object.assign({},j(t),{action:"click",source:"notifications",correlationId:e}))},w=(t,e)=>{Object(s.a)(Object.assign({},j(t),{action:"close",source:"notifications",correlationId:e}))},_=(t,e)=>{Object(s.a)(Object.assign({},j(t),{action:"receive",source:"notifications",correlationId:e}))},k=t=>(e,n)=>{Object(s.a)(Object.assign({},r.defaults(e),{action:(t=>t?"enable":"disable")(n),noun:t,source:"notifications"}))},S=k("chat_messages"),y=k("chat_requests"),N=k("comment_replies"),P=k("desktop_notification_permissions"),I=k("post_replies"),x=k("private_messages"),D=k("trending_posts"),q=k("username_mention"),M=(t,e,n)=>{switch(e){case i.a.ChatMessages:S(t,n),y(t,n);break;case i.a.TrendingPosts:D(t,n);break;case i.a.UnreadMessages:N(t,n),I(t,n),x(t,n),q(t,n)}}},"./src/reddit/models/PushNotification/index.ts":function(t,e,n){"use strict";var i;n.d(e,"a",function(){return i}),function(t){t.ChatMessages="chatMessages",t.TrendingPosts="trendingPosts",t.UnreadMessages="unreadMessages"}(i||(i={}))},"./src/reddit/selectors/experiments/dnPrePrompt.ts":function(t,e,n){"use strict";n.d(e,"a",function(){return s}),n.d(e,"b",function(){return o}),n.d(e,"c",function(){return a});var i=n("./src/reddit/constants/experiments.ts"),r=n("./src/reddit/helpers/chooseVariant/index.ts");const s=t=>{const e=Object(r.b)(t,{experimentEligibilitySelector:r.a,experimentName:i.i});return Object(i.G)(e)?void 0:e},o=t=>t===i.h.DarkPrePrompt||t===i.h.DarkSystemDialogue,a=t=>t===i.h.DarkPrePrompt||t===i.h.PrePrompt}}]);
//# sourceMappingURL=PushNotifications.c65c520e313b11b4b5b7.js.map